# Zalo Bot

> Готовая к продакшену, многоязычная документация по интеграции на Rust с платформой Zalo Official Account (OA).

**Другие языки:** [English](../README.md) · [Tiếng Việt](README.vi.md)

## Цели проекта

Репозиторий предоставляет безопасный сквозной слой интеграции с Zalo Official Account API. Текущие задачи — описать все требуемые возможности, стабилизировать структуру Rust-workspace и собрать строительные блоки для ботов и мини-приложений, соответствующих официальным политикам платформы.

## Обзор Zalo Official Account API

- **Базовый URL:** `https://openapi.zalo.me/v3.0/oa/`. Большинство endpoint'ов расширяют префикс доменно-специфичным сегментом, например `message/cs` или `tag/gettagsofoa`.
- **Типы сообщений:** Customer Service (`cs`), Transaction (`transaction`) и Promotion (`promotion`). Тип влияет на ограничения доставки и допустимый контент.
- **Форматы контента:** текст, вложения (`image`, `file`) и шаблоны со списками и кнопками.
- **Заголовки запросов:** каждый вызов обязан передавать действительный OA `access_token` и корректный `Content-Type` (`application/json` или `multipart/form-data`).

## Аутентификация и жизненный цикл токенов

1. Создайте OA на [Zalo Business](https://business.zalo.me/).
2. Зарегистрируйте приложение на [Zalo Developers](https://developers.zalo.me/), чтобы получить App ID, Secret Key, OA ID и Access Token.
3. Храните и ротируйте Access Token вместе с Refresh Token. Ошибки `-204` и `-240` указывают на истечение токена или необходимость миграции на API v3.
4. Настройте HTTPS-вебхуки для входящих событий и проверяйте MAC-подпись каждого payload'а.

## Ограничения платформы

- **Лимиты запросов:** типовые квоты OA позволяют около 10 запросов в секунду. Ошибка `-210` сигнализирует о превышении.
- **Окно 24 часов:** отправка сообщений вне 24-часового окна вызовет ошибку `-214`; бот обязан отслеживать время последнего взаимодействия с пользователем.
- **Политика контента:** нарушения возвращают ошибку `-215`. Реализуйте валидацию и модерацию до отправки сообщений.

## Ключевые домены API

| Домен | Примерные endpoint'ы | Назначение |
| --- | --- | --- |
| Сообщения | `message/{messageType}` | Доставка текстов, медиа, списков и шаблонов. |
| Управление подписчиками | `getoa`, `getprofile`, `getfollowers`, `updatefollowerinfo` | Доступ к профилям OA, списку подписчиков и обновлению метаданных. |
| Диалоги | `listrecentchat`, `conversation` | Получение списка чатов и истории переписки. |
| Медиа | `upload/image`, `upload/file`, `upload/gif` | Загрузка вложений для последующего использования. |
| Теги | `tag/gettagsofoa`, `tag/tagfollower`, `tag/rmfollowerfromtag` | Управление сегментацией аудитории через теги. |
| Контент OA | `article/create`, `article/upload_video/*`, `article/verify` | Публикация статей, управление видео и проверка черновиков. |
| Магазин | `store/product/*`, `store/order/*` | Управление товарами и заказами OA Store. |
| Вебхук | Произвольный URL | Приём событий follow/unfollow, входящих сообщений, кликов и подтверждений MAC. |

Полный чек-лист методов и контрактов данных находится в [`docs/progress.md`](progress.md).

## Вебхуки и события

Вебхуки OA получают POST-пакеты с полями `app_id`, `sender.id`, `recipient.id`, `event_name`, `timestamp`, `message` и `mac`. Интеграция должна проверять MAC-подпись и обрабатывать события:

- **Жизненный цикл пользователя:** `follow`, `unfollow`.
- **Сообщения:** `user_send_text`, `user_send_image`, `user_send_file`, `user_send_sticker`, `user_send_gif`, `user_send_location`.
- **Интеракции:** `user_click_link`, `user_click_button`, `user_received_message`, `user_seen_message`.

## Диагностика и обработка ошибок

Распространённые коды ошибок Zalo OA API:

| Код | Значение |
| --- | --- |
| `-201` | Отсутствуют обязательные параметры. |
| `-202` | Неверные значения параметров. |
| `-204` | Access Token недействителен или истёк. |
| `-205` | У OA недостаточно прав. |
| `-210` | Превышен лимит запросов. |
| `-211` | OA не прошёл верификацию. |
| `-213` | Пользователь не подписан на OA. |
| `-214` | Сообщение отправлено за пределами окна 24 часов. |
| `-215` | Контент нарушает политику платформы. |
| `-216` | Обнаружен дубликат сообщения. |
| `-240` | Используется устаревшая версия API v2 и требуется обновление. |

## Как работать с репозиторием

- Следите за покрытием endpoint'ов и необходимой бизнес-логикой в [`docs/progress.md`](progress.md).
- Добавляйте ADR и исполняемые примеры вместе с реализацией подсистем, чтобы фиксировать архитектурные решения и сценарии отказов.
- Перед интеграцией с конкретным endpoint'ом проверяйте требования по аутентификации, лимитам и формату payload'ов выбранного домена.

## Структура Rust-workspace

Репозиторий организован как многокрейтовый workspace:

- `crates/zalo-types` — общие типы, загрузчик конфигурации (`ConfigLoader`) и маппинг ошибок на [`masterror`](https://crates.io/crates/masterror).
- `crates/zalo-sdk` — лёгкий SDK для Mini App с валидацией контекста и генерацией handshake-пейлоадов.
- `crates/zalo-bot` — утилиты для OA Bot: инициализация `tracing` (`init_tracing`) и проверка подписи вебхуков (`WebhookVerifier`).
- `examples/miniapp-leptos` — пример Mini App, демонстрирующий использование SDK.
- `examples/bot-axum` — пример инициализации вебхука на базе `zalo-bot`.

### Конфигурация

`ConfigLoader` считывает переменные окружения с префиксом `ZALO_BOT_` и необязательный TOML-файл. Поддерживаемые секции:

- `environment` — одно из значений `development`, `staging` или `production`.
- `[logging]` — поля `filter` (выражение для `tracing_subscriber::EnvFilter`) и `format` (`text` или `json`).

### Контроль качества

Выполняйте следующие команды перед публикацией изменений, чтобы гарантировать единые форматирование, линтинг, тесты и документацию:

```
cargo +nightly fmt --
cargo clippy -D warnings
cargo test --all
cargo doc --no-deps
```

Безопасность зависимостей проверяйте через `cargo audit` и `cargo deny`.

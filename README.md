# Zalo Bot

Проект нацелен на полноценную и безопасную интеграцию с Zalo Official Account (OA) API. Основной артефакт на текущем этапе — детализация требований к клиентской библиотеке бота и список API-методов, которые необходимо реализовать для полного покрытия возможностей официального API.

## Обзор Zalo Official Account API

- **Базовый URL**: `https://openapi.zalo.me/v3.0/oa/`. В большинстве методов путь продолжает этот префикс и уточняет домен (например, `message/cs`, `tag/gettagsofoa`).
- **Типы сообщений**: Customer Service (`cs`), Transaction (`transaction`), Promotion (`promotion`). Выбор типа влияет на ограничения отправки и допустимый контент.
- **Форматы контента**: текст, вложения с типами `image`, `file`, шаблоны (`template`) со списками элементов и кнопками.
- **Заголовки запросов**: все вызовы требуют заголовка `access_token` с действительным OA Access Token и корректного `Content-Type` (`application/json` или `multipart/form-data`).

## Аутентификация и управление токенами

1. Создайте OA на [Zalo Business](https://business.zalo.me/).
2. Зарегистрируйте приложение в [Zalo Developers](https://developers.zalo.me/) и получите App ID, Secret Key, OA ID и Access Token.
3. Храните и обновляйте Access Token и Refresh Token — ошибки `-204` и `-240` сигнализируют об истечении токена либо необходимости перехода на API v3.
4. Приём входящих событий настраивается через HTTPS вебхуки с проверкой MAC-подписи.

## Ограничения платформы

- **Лимиты**: типичные ограничения составляют 10 запросов в секунду на OA. Ошибка `-210` сигнализирует о превышении.
- **Ограничение 24 часов**: сообщение за пределами 24-часового окна вызовет ошибку `-214`, поэтому необходимо вести учёт последнего контакта.
- **Политики контента**: нарушение правил приводит к ошибке `-215`; стоит внедрять валидацию и модерацию сообщений до отправки.

## Ключевые домены API

| Домен | Ключевые endpoint'ы | Назначение |
| --- | --- | --- |
| Сообщения | `message/{messageType}` | Текстовые сообщения, изображения, файлы, списки и шаблоны. |
| Управление подписчиками | `getoa`, `getprofile`, `getfollowers`, `updatefollowerinfo` | Получение профилей, списка подписчиков и обновление данных. |
| Диалоги | `listrecentchat`, `conversation` | Получение списка чатов и истории переписки. |
| Медиа | `upload/image`, `upload/file`, `upload/gif` | Загрузка вложений для дальнейшей отправки. |
| Теги | `tag/gettagsofoa`, `tag/tagfollower`, `tag/rmfollowerfromtag` | Управление тегами и сегментацией аудитории. |
| Контент OA | `article/create`, `article/upload_video/*`, `article/verify` | Публикация статей, работа с видео и проверка статей. |
| Магазин | `store/product/*`, `store/order/*` | Управление товарами и заказами OA Store. |
| Вебхук | Пользовательский URL | Приём событий: follow/unfollow, сообщения, клики, подтверждение MAC. |

Полный перечень методов и структур поддерживается в [`docs/progress.md`](docs/progress.md).

## Вебхуки и события

Вебхук OA принимает POST-запросы с полями `app_id`, `sender.id`, `recipient.id`, `event_name`, `timestamp`, `message` и `mac`. Нужно реализовать проверку подписи и поддержку событий:

- **Пользовательские события**: `follow`, `unfollow`.
- **Сообщения**: `user_send_text`, `user_send_image`, `user_send_file`, `user_send_sticker`, `user_send_gif`, `user_send_location`.
- **Интеракции**: `user_click_link`, `user_click_button`, `user_received_message`, `user_seen_message`.

## Диагностика и обработка ошибок

Распространённые коды ошибок Zalo OA API:

| Код | Значение |
| --- | --- |
| `-201` | Отсутствуют обязательные параметры. |
| `-202` | Неверные значения параметров. |
| `-204` | Недействительный или истёкший Access Token. |
| `-205` | Недостаточно прав у OA. |
| `-210` | Превышен rate limit. |
| `-211` | OA не прошёл верификацию. |
| `-213` | Пользователь не подписан на OA. |
| `-214` | Сообщение отправлено вне 24-часового окна. |
| `-215` | Контент нарушает политику. |
| `-216` | Дубликат сообщения. |
| `-240` | Используется устаревший API v2. |

## Как пользоваться репозиторием

- Переходите в [`docs/progress.md`](docs/progress.md), чтобы отслеживать закрытие каждого endpoint'а и связанной бизнес-логики.
- Добавляйте ADR и примеры при реализации подсистем, чтобы документировать архитектурные решения и сценарии отказов.
- Перед реализацией конкретного метода проверяйте требования по аутентификации, лимитам и формату данных для выбранного домена.
